---
title: "Multi-class simulation"
date: "4/12/2019"
output: html_document
---


Use simulation data to test our proposed model 1~3 

```{R set up}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(ggpubr)
})

source('~/GoogleDrive/pjs/kTSP/code/utils.R')
```



### Set parameters and simulate training & testing data
```{R parameters}
g.null <- 160
g.sig <- 40
n.train <- c(80, 80, 80) # class 0,1,2
n.test <- c(80, 80, 80)
SDnullMu <- 5
DFnullSD <- 7
lb.shift <- 0.6
ub.shift <- 1.1
testMu.shift <- 0
testSD.shift <- 4
pShift <- 0.7


Ks <- seq(10, 100, by=10)
alpha <- c(0, 0.25, 0.5, 0.75, 1)
```


```{R create}
# Loop for different simulation with different alpha
out.sets <- list()
for (a in alpha) {
  out <- simu.multi(g.null, g.sig, a, n.train, n.test, SDnullMu, DFnullSD, lb.shift, ub.shift, testMu.shift, testSD.shift, pShift)
  out.sets[[as.character(a)]] <- out
  
  # # # Get results
  # sig.idx <- out$sig.idx
  # expr.test <- out$Xtest
  # expr.train <- out$Xtrain
  # 
  # 
  # # Function for plots
  # add_legend <- function(...) {
  #   opar <- par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0),
  #               mar=c(0, 0, 0, 0), new=TRUE)
  #   on.exit(par(opar))
  #   plot(0, 0, type='n', bty='n', xaxt='n', yaxt='n')
  #   legend(...)
  # }
  # 
  # # Distribution of training set
  # df <- expr.train # expr.test
  # par(mar = c(5, 4, 1.4, 0.2))
  # plot(NA, xlim=c(1, ncol(df)), ylim=range(df), xlab="Sample", ylab="Expression", main='Training Set')
  # for (i in (length(sig.idx[sig.idx!='N'])+1):nrow(df)) {
  #   lines(x=1:ncol(df), y=df[i,], col="lightgrey")
  # }
  # aidx <- length(sig.idx[sig.idx=='A'])
  # if (aidx != 0) {
  #   for (i in 1:aidx) {
  #     lines(x=1:ncol(df), y=df[i, ], col="#E74C3C")
  #   }
  # }
  # if (length(sig.idx[sig.idx=='B']) != 0) {
  #   for (i in (aidx+1):length(sig.idx[sig.idx!='N'])) {
  #     lines(x=1:ncol(df), y=df[i,], col="#69D6D2")
  #   }
  # }
  # add_legend('topright', legend=c('Type A', 'Type B', 'Null'), pch=20, cex=0.8, bty='n',
  #        horiz=T, col=c("#E74C3C", "#1FD1D4", "#e2e2e4"))
  
}
```



### Loop over model baseline & 1 to 3
```{R perform}
all.results <- list()
for (a in alpha) {
  print(paste0('The percentage of only-one-DE alpha = ', a))
  all.results[[as.character(a)]] <- list()
  out <- out.sets[[as.character(a)]]
  
  # Get outputs
  expr.train <- out$Xtrain
  expr.test <- out$Xtest
  lb.train <- out$Ytrain
  lb.test <- out$Ytest
  sig.dix <- out$sig.idx
  
  # Calculate ktsp scores in different ways
  grps <- as.character(unique(lb.train))
  one.tsp <- getTSP(grps, expr.train, lb.train, 'one') 
  pw.tsp <- getTSP(grps, expr.train, lb.train, 'pairwise')
  kpairs <- list()
  
  # Train baseline model
  print(paste0('  Running baseline model...'))
  all.results[[as.character(a)]][['baseline']] <- list()
  all.results[[as.character(a)]][['baseline']][['cv']] <- tsp.rf.cv(5, Ks, lb.train, as.data.frame(t(expr.train)), grps, kpairs, 0, baseline = TRUE)
  all.results[[as.character(a)]][['baseline']][['overall.cv']] <- getOverall(all.results[[as.character(a)]][['baseline']][['cv']], Ks, baseline = TRUE)
  all.results[[as.character(a)]][['baseline']][['full.model']] <- trainModel(as.data.frame(t(expr.train)), lb.train, Ks, grps, kpairs, 0, baseline = TRUE)
  all.results[[as.character(a)]][['baseline']][['test']] <- testing(as.data.frame(t(expr.test)), lb.test, Ks, grps, kpairs, all.results[[as.character(a)]][['baseline']][['full.model']], 0, baseline=TRUE)
  
  # Loop over model 1 to 3
  for (i in 1:2) {
    print(paste0('  Running model ', i, '...'))
    chri <- as.character(i)
    kpairs[[chri]] <- list()
    all.results[[as.character(a)]][[chri]] <- list()
    
    # Extract top K gene pairs
    ifelse(i == 1, kpairs[[chri]] <- mergePairs(Ks, one.tsp, i), kpairs[[chri]] <- mergePairs(Ks, pw.tsp, i)) 
    
    # 5 fold cross-validation & performances
    all.results[[as.character(a)]][[chri]][['cv']] <- tsp.rf.cv(5, Ks, lb.train, as.data.frame(t(expr.train)), grps, kpairs, i)
    all.results[[as.character(a)]][[chri]][['overall.cv']] <- getOverall(all.results[[as.character(a)]][[chri]][['cv']], Ks)
    
    # Train a model using all training set
    all.results[[as.character(a)]][[chri]][['full.model']] <- trainModel(as.data.frame(t(expr.train)), lb.train, Ks, grps, kpairs, i)
    
    # Test on independent set
    all.results[[as.character(a)]][[chri]][['test']] <- testing(as.data.frame(t(expr.test)), lb.test, Ks, grps, 
                                          kpairs, all.results[[as.character(a)]][[chri]][['full.model']], i)
  }
  all.results[[as.character(a)]][['kpairs']] <- kpairs
}

#save(all.results, file = '~/ktsp/multi.results/simulation/all.results.Rdata')
```



### Draw the performances
```{R draw}
plot.perf <- function(modelName, a.results, Ks, name, listname, whichone) {
  df <- setNames(data.frame(matrix(ncol=3, nrow=0)), c('K', listname, 'model'))
  for (n in modelName) {
    if (whichone == "CV") {
      overall <- a.results[[n]][['overall.cv']]
    } else if (whichone == "Test") {
      overall <- a.results[[n]][['test']]
    } else {print('whichone only include CV or Test!')}

    for (k in 1:length(Ks)) {
      K <- Ks[k]
      ifelse(n == "baseline", df[nrow(df)+1, ][[listname]] <- overall[[listname]], 
                              df[nrow(df)+1, ][[listname]] <- overall[[as.character(K)]][[listname]])
      df[nrow(df), ]$model <- paste0(n)
      df[nrow(df), ]$K <- K
    }
  }
  rownames(df) <- NULL
  df$K <- factor(df$K)
  #colrs <- getColors(length(modelName))
  
  ggplot(df, aes(x=K, y=get(listname), group=model)) + geom_line(aes(color=model)) + 
    geom_point(aes(color=model)) + scale_color_manual(values = rev(brewer.pal(4,"Spectral"))) +
    theme_bw() + labs(y=name) 
    #scale_y_continuous(breaks = seq(yrange[1], yrange[2], by=0.1), limits = yrange)
}

#models <- c("baseline", "1", "2", "3")
models <- c("baseline", "1", "2")
paras <- c('ACC', 'avg.sens', 'avg.spec', 'avg.yd')
names <- c('Accuracy', 'Avg. Sensitivity', 'Avg. Specificity', 'Avg. Youden')

for (a in alpha) {
  a.results <- all.results[[as.character(a)]]
  for (i in 1:length(paras)) {
    name <- names[i]
    listname <- paras[i]
    assign(paste0("p", i) ,plot.perf(models, a.results, Ks, name, listname, 'CV'))
    assign(paste0("t", i) ,plot.perf(models, a.results, Ks, name, listname, 'Test'))
  }
  fig <- ggarrange(p1, p2, p3, p4, nrow=2, ncol=2, common.legend=T, legend='right')
  print(annotate_figure(fig, top=paste0('5 Fold Cross Validation', ' | alpha = ', a)))

  fig <- ggarrange(t1, t2, t3, t4, nrow=2, ncol=2, common.legend=T, legend='right')
  print(annotate_figure(fig, top=paste0('Testing', ' | alpha = ', a)))
}
```


### Gene pairs
```{R, eval=F}
# Expression pattern
plot(NA,xlim=c(1, ncol(expr.train)), ylim=range(expr.train), xlab="sample", ylab="expression")
for(i in c(26,8)) {
  lines(x=1:ncol(expr.train), y=expr.train[i,], col=getColors(1))
}


```
